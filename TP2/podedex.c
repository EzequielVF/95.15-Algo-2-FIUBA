#include "pokedex.h"
#include "lista.h"
#include "abb.h"
#include <stdio.h>
#include <string.h>
#include <stdbool.h>
#include <stdlib.h>
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#define ERROR -1
#define EXITO 0
#define FORMATO_LECTURA_AVISTAMIENTOS "%i;%[^;];%[^;];%[^;];%i;%c\n"
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const int PARAMETROS_LEIDOS = 6;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
especie_pokemon_t* crear_especie(int numero, char* nombre, char* descripcion){
    especie_pokemon_t* aux = malloc(sizeof(especie_pokemon_t));
    if(!aux)
        return NULL;

    aux->numero = numero;
    strcpy(aux->nombre, nombre);
    strcpy(aux->descripcion, descripcion);
    aux->pokemones = lista_crear();

    return aux;
}

particular_pokemon_t* crear_pokemon(char* nombre, int nivel, char capturado){
    particular_pokemon_t* aux = malloc(sizeof(particular_pokemon_t));
    if(!aux)
        return NULL;

    strcpy(aux->nombre, nombre);
    aux->nivel = nivel;
    aux->capturado = capturado;

    return aux;
}

int insertar_en_lista_de_especie(void* especie, void* pokemon){
    if(!especie || !pokemon)
		return ERROR;

    lista_insertar(((especie_pokemon_t*)especie)->pokemones, pokemon);
    return EXITO;
}

int comparar_cosas(void* elemento1, void* elemento2){
	if(!elemento1 || !elemento2)
		return 0;

	if(((especie_pokemon_t*)elemento1)->numero > ((especie_pokemon_t*)elemento2)->numero )
		return 1;
	
	if(((especie_pokemon_t*)elemento1)->numero < ((especie_pokemon_t*)elemento2)->numero )
		return -1;
	
	return 0;
}

void destruir_cosa(especie_pokemon_t* elemento){
	lista_destruir(elemento->pokemones);
    free(elemento);
}

void destructor_de_cosas(void* elemento){
	if(!elemento)
		return;
	
	destruir_cosa((especie_pokemon_t*)elemento);
}
///////////////////////////////////////////////////////FUNCIONES BASICAS///////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////CREAR POKEDEX//////////////////////////////////////////////////////////////////////
pokedex_t* pokedex_crear(char entrenador[MAX_NOMBRE]){
    pokedex_t* pokedex = NULL;
    pokedex = malloc(sizeof(pokedex_t));

    if(!pokedex)
        return NULL;

    strcpy(pokedex->nombre_entrenador, entrenador);
    pokedex->pokemones = NULL;
    pokedex->ultimos_capturados = NULL;
    pokedex->ultimos_vistos = NULL;
    return pokedex;
}
/////////////////////////////////////////////////////////POKEDEX AVISTAR////////////////////////////////////////////////////////////////////
int pokedex_avistar(pokedex_t* pokedex, char ruta_archivo[MAX_RUTA]){
    if(!pokedex)
        return ERROR;

    FILE* avistamientostxt = fopen(ruta_archivo, "r");
    if(!avistamientostxt)
        return ERROR;
    
    especie_pokemon_t* especie_leida;
    particular_pokemon_t* pokemon_leido;
    bool problemas_lectura = false;
    bool inserto_pokemon = false;
    bool inserto_en_pila = false;
    bool inserto_en_cola = false;
    bool problemas_insercion = false;
    int leido = 0;
    int estado = EXITO;
    int numero_especie = 0;
    int comparador = 0;
    int nivel_pokemon = 0;
    char nombre_especie[MAX_NOMBRE];
    char descripcion_especie[MAX_DESCRIPCION];
    char nombre_pokemon[MAX_NOMBRE];
    char capturado = '0';

    leido = fscanf(avistamientostxt, FORMATO_LECTURA_AVISTAMIENTOS, &numero_especie, nombre_especie, descripcion_especie, nombre_pokemon, &nivel_pokemon, &capturado);
    if(leido != PARAMETROS_LEIDOS){
        problemas_lectura = true;
        fclose(avistamientostxt);
        return ERROR;
    }
    while(leido = PARAMETROS_LEIDOS && !problemas_lectura && !problemas_insercion){
        especie_leida = crear_especie(numero_especie, nombre_especie, descripcion_especie);
        pokemon_leido = crear_pokemon(nombre_pokemon, nivel_pokemon, capturado);

        if(pokedex->pokemones == NULL){
        pokedex->pokemones = arbol_crear(comparar_cosas, destructor_de_cosas);
        }
        if(pokedex->ultimos_capturados == NULL){
        pokedex->ultimos_capturados = lista_crear(); ///ESTO UNA PILA
        }
        if(pokedex->ultimos_vistos == NULL){
        pokedex->ultimos_vistos = lista_crear(); ///ESTO ES UNA COLA
        }

        if((especie_pokemon_t*)arbol_buscar(pokedex->pokemones, especie_leida) == NULL){ ///INSERTO LA ESPECIE EN EL ARBOL SI NO ESTA
            arbol_insertar(pokedex->pokemones, especie_leida);
        }

        if(insertar_en_lista_del_elemento(pokedex->pokemones, especie_leida, insertar_en_lista_de_especie, pokemon_leido) == EXITO){ ///INSERTO EL POKEMON DENTRO DE LA ESPECIE
            inserto_pokemon = true;
        }

        if(lista_encolar(pokedex->ultimos_vistos, pokemon_leido) == EXITO){ ///INSERTO POKEMON EN LA COLA DE VISTOS
            inserto_en_cola = true;
        }
        if(pokemon_leido->capturado == 'S'){
            if(lista_apilar(pokedex->ultimos_capturados, pokemon_leido) == EXITO){ /// INSERTO POKEMON EN LA PILA DE CAPTURADOS
                inserto_en_pila = true;
            }
        }
        if(!inserto_en_cola || !inserto_en_pila || !inserto_pokemon) ///VERIFICO QUE TODO FUNCIONO
            problemas_insercion = true;

        leido = fscanf(avistamientostxt, FORMATO_LECTURA_AVISTAMIENTOS, &numero_especie, nombre_especie, descripcion_especie, nombre_pokemon, &nivel_pokemon, &capturado); /// VUELVO A LEER
        if(leido != PARAMETROS_LEIDOS){
            problemas_lectura = true;
            fclose(avistamientostxt);
        }
    }

    fclose(avistamientostxt);

    if(!inserto_en_cola || !inserto_en_pila || !inserto_pokemon){
        estado = ERROR;
    }

    return estado;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////